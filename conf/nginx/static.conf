# Config for nginx 1.11, generated by Docker (jkulak/nginx-static)

# Limit connections per IP
limit_req_zone $binary_remote_addr zone=ratezone:20m rate=16r/s;
limit_req zone=ratezone burst=160 nodelay;

server {

    listen 20333;
    server_name localhost;
    error_log  /var/log/nginx/error.log;
    access_log /var/log/nginx/access.log;
    root /var/www/static;

    # Set size limits & buffer overflows
    client_body_buffer_size  1K;
    client_header_buffer_size 1k;
    client_max_body_size 1k;
    large_client_header_buffers 2 1k;

    # Set timeouts
    client_body_timeout 10;
    client_header_timeout 10;
    keepalive_timeout 5 5;
    send_timeout 10;

    # TODO: check that directive
    # Directive describes the zone, in which the session states are stored i.e. store in slimits.
    # 1m can handle 32000 sessions with 32 bytes/session, set to 5m x 32000 session
    # limit_zone slimits $binary_remote_addr 5m;

    # TODO: check that directive
    # Control maximum number of simultaneous connections for one session i.e.
    # restricts the amount of connections from a single ip address
    # limit_conn slimits 5;

    # Only requests to our host are allowed
    # if ($host !~ ^(example.com|www.example.com|s.example.com)$ ) {
    #    return 444;
    # }

    # Only allow these request methods
    if ($request_method !~ ^(GET|HEAD)$ ) {
        return 444;
    }

    # Block download agents
    if ($http_user_agent ~* LWP::Simple|BBBike|wget) {
        return 403;
    }

    # Block certain robots robots ##
    if ($http_user_agent ~* msnbot|scrapbot) {
        return 403;
    }

    # Deny certain Referers - Referral Spam
    if ( $http_referer ~* (babes|forsale|girl|jewelry|love|nudit|organic|poker|porn|sex|teen) ) {
        return 403;
    }

    # Disable hotlinking and serve special image inst
    # location / {
    #    valid_referers none blocked www.example.com example.com;
    #    if ($invalid_referer) {
    #        return   403;
    #    }
    #}

    # Turn off server identification (version)
    server_tokens off;

    # Allow for static files
    location ~* \.(?:manifest|appcache|html?|xml|json)$ {
        expires -1;
    }

    # Feeds
    location ~* \.(?:rss|atom)$ {
        expires 1h;
    }

    # Media files: images, icons, video, audio, HTC
    location ~* \.(?:jpg|jpeg|gif|png|ico|cur|gz|svg|svgz|mp4|ogg|ogv|webm|htc)$ {
        expires 1M;
        access_log off;
        add_header Cache-Control "public";
    }

    # CSS and Javascript
    location ~* \.(?:css|js)$ {
        expires 1y;
        access_log off;
    }

    # Block everything else
    location  / {
        deny all;
    }
}
